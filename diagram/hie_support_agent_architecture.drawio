<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2024-12-24T12:00:00.000Z" agent="Mozilla/5.0" version="22.1.0" etag="architecture" type="device">
  <diagram id="architecture-diagram" name="System Architecture">
    <mxGraphModel dx="1400" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200" math="0" shadow="1">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="HIE Support Agent - System Architecture" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=28;fontStyle=1;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="800" height="50" as="geometry" />
        </mxCell>

        <!-- Subtitle -->
        <mxCell id="subtitle" value="AI-Powered Support System for Parents of Children with Hypoxic-Ischemic Encephalopathy" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=2;fontColor=#64748b;" vertex="1" parent="1">
          <mxGeometry x="400" y="65" width="800" height="30" as="geometry" />
        </mxCell>

        <!-- User Layer Background -->
        <mxCell id="user-layer-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8f5e9;strokeColor=#81c784;strokeWidth=2;opacity=50;" vertex="1" parent="1">
          <mxGeometry x="40" y="110" width="280" height="280" as="geometry" />
        </mxCell>

        <mxCell id="user-layer-title" value="USER LAYER" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#2e7d32;" vertex="1" parent="1">
          <mxGeometry x="40" y="115" width="280" height="20" as="geometry" />
        </mxCell>

        <!-- User Icon -->
        <mxCell id="user" value="" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=default;verticalAlign=top;aspect=fixed;imageAspect=0;image=data:image/svg+xml,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM0Y2FmNTAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMjAgMjF2LTJhNCA0IDAgMCAwLTQtNEg4YTQgNCAwIDAgMC00IDR2MiI+PC9wYXRoPjxjaXJjbGUgY3g9IjEyIiBjeT0iNyIgcj0iNCI+PC9jaXJjbGU+PC9zdmc+;" vertex="1" parent="1">
          <mxGeometry x="145" y="145" width="70" height="70" as="geometry" />
        </mxCell>

        <mxCell id="user-label" value="&lt;b&gt;Parent User&lt;/b&gt;&lt;br&gt;(Sarah / Marcus Persona)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontColor=#1b5e20;" vertex="1" parent="1">
          <mxGeometry x="100" y="220" width="160" height="40" as="geometry" />
        </mxCell>

        <!-- Browser -->
        <mxCell id="browser" value="Web Browser" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c8e6c9;strokeColor=#43a047;strokeWidth=2;fontStyle=1;fontSize=12;fontColor=#1b5e20;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="105" y="280" width="150" height="45" as="geometry" />
        </mxCell>

        <!-- Email Auth -->
        <mxCell id="email-auth" value="Email Authentication" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#a5d6a7;strokeColor=#388e3c;strokeWidth=1;fontSize=10;fontColor=#1b5e20;" vertex="1" parent="1">
          <mxGeometry x="55" y="340" width="100" height="35" as="geometry" />
        </mxCell>

        <!-- Persona Selection -->
        <mxCell id="persona-select" value="Persona Selection" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#a5d6a7;strokeColor=#388e3c;strokeWidth=1;fontSize=10;fontColor=#1b5e20;" vertex="1" parent="1">
          <mxGeometry x="205" y="340" width="100" height="35" as="geometry" />
        </mxCell>

        <!-- Frontend Layer Background -->
        <mxCell id="frontend-layer-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e3f2fd;strokeColor=#64b5f6;strokeWidth=2;opacity=50;" vertex="1" parent="1">
          <mxGeometry x="360" y="110" width="320" height="280" as="geometry" />
        </mxCell>

        <mxCell id="frontend-layer-title" value="FRONTEND LAYER (Streamlit)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#1565c0;" vertex="1" parent="1">
          <mxGeometry x="360" y="115" width="320" height="20" as="geometry" />
        </mxCell>

        <!-- Streamlit App -->
        <mxCell id="streamlit-app" value="&lt;b&gt;streamlit_app.py&lt;/b&gt;&lt;br&gt;Main UI Controller" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1976d2;strokeWidth=2;fontSize=11;fontColor=#0d47a1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="420" y="145" width="200" height="50" as="geometry" />
        </mxCell>

        <!-- Chat Interface -->
        <mxCell id="chat-interface" value="Chat Interface" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#90caf9;strokeColor=#1565c0;strokeWidth=1;fontSize=10;fontColor=#0d47a1;" vertex="1" parent="1">
          <mxGeometry x="380" y="210" width="90" height="35" as="geometry" />
        </mxCell>

        <!-- History Renderer -->
        <mxCell id="history-renderer" value="History Renderer" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#90caf9;strokeColor=#1565c0;strokeWidth=1;fontSize=10;fontColor=#0d47a1;" vertex="1" parent="1">
          <mxGeometry x="480" y="210" width="90" height="35" as="geometry" />
        </mxCell>

        <!-- Citation Display -->
        <mxCell id="citation-display" value="Citation Display" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#90caf9;strokeColor=#1565c0;strokeWidth=1;fontSize=10;fontColor=#0d47a1;" vertex="1" parent="1">
          <mxGeometry x="580" y="210" width="85" height="35" as="geometry" />
        </mxCell>

        <!-- Privacy Controls -->
        <mxCell id="privacy-controls" value="&lt;b&gt;Privacy Controls&lt;/b&gt;&lt;br&gt;View/Delete Data" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#64b5f6;strokeColor=#1976d2;strokeWidth=2;fontSize=10;fontColor=#0d47a1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="380" y="260" width="130" height="45" as="geometry" />
        </mxCell>

        <!-- Consent Manager -->
        <mxCell id="consent-manager" value="&lt;b&gt;Consent Manager&lt;/b&gt;&lt;br&gt;User Notifications" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#64b5f6;strokeColor=#1976d2;strokeWidth=2;fontSize=10;fontColor=#0d47a1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="525" y="260" width="130" height="45" as="geometry" />
        </mxCell>

        <!-- Session State -->
        <mxCell id="session-state" value="&lt;b&gt;Session State&lt;/b&gt;&lt;br&gt;messages, context_history, user_email, persona" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#42a5f5;strokeColor=#1565c0;strokeWidth=2;fontSize=9;fontColor=#ffffff;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="395" y="320" width="250" height="55" as="geometry" />
        </mxCell>

        <!-- Agent Layer Background -->
        <mxCell id="agent-layer-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff3e0;strokeColor=#ffb74d;strokeWidth=2;opacity=50;" vertex="1" parent="1">
          <mxGeometry x="720" y="110" width="280" height="280" as="geometry" />
        </mxCell>

        <mxCell id="agent-layer-title" value="AGENT LAYER (Python)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#e65100;" vertex="1" parent="1">
          <mxGeometry x="720" y="115" width="280" height="20" as="geometry" />
        </mxCell>

        <!-- DifyAgent -->
        <mxCell id="dify-agent" value="&lt;b&gt;DifyAgent&lt;/b&gt;&lt;br&gt;(agent.py)&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;MS Agent Framework Adapter&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe0b2;strokeColor=#f57c00;strokeWidth=2;fontSize=11;fontColor=#e65100;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="770" y="145" width="180" height="60" as="geometry" />
        </mxCell>

        <!-- DifyChatClient -->
        <mxCell id="dify-chat-client" value="&lt;b&gt;DifyChatClient&lt;/b&gt;&lt;br&gt;(dify_client.py)&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Chat API Communication&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#ef6c00;strokeWidth=2;fontSize=10;fontColor=#e65100;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="735" y="220" width="130" height="55" as="geometry" />
        </mxCell>

        <!-- DifyKnowledgeClient -->
        <mxCell id="dify-knowledge-client" value="&lt;b&gt;DifyKnowledgeClient&lt;/b&gt;&lt;br&gt;(knowledge_client.py)&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;User History Storage&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#ef6c00;strokeWidth=2;fontSize=10;fontColor=#e65100;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="875" y="220" width="115" height="55" as="geometry" />
        </mxCell>

        <!-- DifySummarizer -->
        <mxCell id="dify-summarizer" value="&lt;b&gt;DifySummarizer&lt;/b&gt;&lt;br&gt;(summarizer.py)&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Message Summarization&lt;br&gt;PII Extraction&lt;br&gt;HIE Detection&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffb74d;strokeColor=#f57c00;strokeWidth=2;fontSize=10;fontColor=#e65100;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="770" y="290" width="180" height="85" as="geometry" />
        </mxCell>

        <!-- Dify Platform Background -->
        <mxCell id="dify-layer-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fce4ec;strokeColor=#f48fb1;strokeWidth=2;opacity=50;" vertex="1" parent="1">
          <mxGeometry x="1040" y="110" width="280" height="280" as="geometry" />
        </mxCell>

        <mxCell id="dify-layer-title" value="DIFY PLATFORM (External)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#c2185b;" vertex="1" parent="1">
          <mxGeometry x="1040" y="115" width="280" height="20" as="geometry" />
        </mxCell>

        <!-- Chat API -->
        <mxCell id="chat-api" value="&lt;b&gt;Chat API&lt;/b&gt;&lt;br&gt;/v1/chat-messages&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;RAG-powered responses&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd9;strokeColor=#ec407a;strokeWidth=2;fontSize=10;fontColor=#880e4f;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1070" y="145" width="130" height="60" as="geometry" />
        </mxCell>

        <!-- Knowledge Base API -->
        <mxCell id="knowledge-api" value="&lt;b&gt;Knowledge Base API&lt;/b&gt;&lt;br&gt;/v1/datasets/.../segments&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;User history CRUD&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd9;strokeColor=#ec407a;strokeWidth=2;fontSize=10;fontColor=#880e4f;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1070" y="220" width="140" height="55" as="geometry" />
        </mxCell>

        <!-- Completion API -->
        <mxCell id="completion-api" value="&lt;b&gt;Completion API&lt;/b&gt;&lt;br&gt;/v1/completion-messages&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Text summarization&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd9;strokeColor=#ec407a;strokeWidth=2;fontSize=10;fontColor=#880e4f;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1070" y="290" width="140" height="55" as="geometry" />
        </mxCell>

        <!-- LLM Icon -->
        <mxCell id="llm-icon" value="&lt;b&gt;LLM&lt;/b&gt;&lt;br&gt;(Claude/GPT)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e91e63;strokeColor=#880e4f;strokeWidth=2;fontSize=10;fontColor=#ffffff;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1230" y="195" width="80" height="80" as="geometry" />
        </mxCell>

        <!-- HIE Knowledge Base -->
        <mxCell id="hie-knowledge" value="&lt;b&gt;HIE Knowledge&lt;/b&gt;&lt;br&gt;Documents" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=10;fillColor=#f48fb1;strokeColor=#c2185b;strokeWidth=2;fontSize=10;fontColor=#880e4f;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1230" y="290" width="80" height="70" as="geometry" />
        </mxCell>

        <!-- Data Storage Background -->
        <mxCell id="data-layer-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#7986cb;strokeWidth=2;opacity=50;" vertex="1" parent="1">
          <mxGeometry x="40" y="430" width="1280" height="150" as="geometry" />
        </mxCell>

        <mxCell id="data-layer-title" value="DATA STORAGE LAYER" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#303f9f;" vertex="1" parent="1">
          <mxGeometry x="40" y="435" width="200" height="20" as="geometry" />
        </mxCell>

        <!-- User History Store -->
        <mxCell id="user-history-store" value="&lt;b&gt;User History Store&lt;/b&gt;&lt;br&gt;(Dify Knowledge Base)&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;JSON Segments per User&lt;/font&gt;" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#9fa8da;strokeColor=#3f51b5;strokeWidth=2;fontSize=11;fontColor=#1a237e;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="465" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- Data Schema -->
        <mxCell id="data-schema" value="&lt;div style=&quot;text-align:left;font-size:9px;font-family:monospace;&quot;&gt;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&quot;email&quot;: &quot;user@example.com&quot;,&lt;br&gt;&amp;nbsp;&amp;nbsp;&quot;name&quot;: &quot;User Name&quot;,&lt;br&gt;&amp;nbsp;&amp;nbsp;&quot;history&quot;: [&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;timestamp&quot;: &quot;...&quot;,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;role&quot;: &quot;user|assistant&quot;,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;summary&quot;: &quot;...&quot;,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;question_hie_related&quot;: &quot;yes|no&quot;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br&gt;&amp;nbsp;&amp;nbsp;]&lt;br&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c5cae9;strokeColor=#5c6bc0;strokeWidth=1;fontSize=9;fontColor=#1a237e;align=left;" vertex="1" parent="1">
          <mxGeometry x="280" y="460" width="200" height="110" as="geometry" />
        </mxCell>

        <!-- Conversation Context -->
        <mxCell id="conversation-context" value="&lt;b&gt;Conversation Context&lt;/b&gt;&lt;br&gt;(Session State)&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;In-memory during session&lt;/font&gt;" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#9fa8da;strokeColor=#3f51b5;strokeWidth=2;fontSize=11;fontColor=#1a237e;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="520" y="465" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- Dify Conversation ID -->
        <mxCell id="dify-conv-id" value="&lt;b&gt;Dify Conversation&lt;/b&gt;&lt;br&gt;(conversation_id)&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Multi-turn context&lt;/font&gt;" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#9fa8da;strokeColor=#3f51b5;strokeWidth=2;fontSize=11;fontColor=#1a237e;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="710" y="465" width="140" height="100" as="geometry" />
        </mxCell>

        <!-- Environment Config -->
        <mxCell id="env-config" value="&lt;b&gt;Environment Config&lt;/b&gt;&lt;br&gt;(.env)&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;DIFY_URL, DIFY_API&lt;br&gt;DIFY_DATASET_ID&lt;br&gt;DIFY_DOCUMENT_ID&lt;/font&gt;" style="shape=document;whiteSpace=wrap;html=1;boundedLbl=1;fillColor=#c5cae9;strokeColor=#5c6bc0;strokeWidth=2;fontSize=10;fontColor=#1a237e;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="890" y="465" width="130" height="100" as="geometry" />
        </mxCell>

        <!-- Prompts -->
        <mxCell id="prompts" value="&lt;b&gt;System Prompts&lt;/b&gt;&lt;br&gt;(Prompts/)&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;HIE expertise template&lt;/font&gt;" style="shape=document;whiteSpace=wrap;html=1;boundedLbl=1;fillColor=#c5cae9;strokeColor=#5c6bc0;strokeWidth=2;fontSize=10;fontColor=#1a237e;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1060" y="465" width="130" height="100" as="geometry" />
        </mxCell>

        <!-- Connection Arrows -->
        <!-- User to Browser -->
        <mxCell id="arrow1" value="" style="endArrow=classic;startArrow=classic;html=1;strokeWidth=2;strokeColor=#43a047;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="user-label" target="browser">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="180" y="265" as="sourcePoint" />
            <mxPoint x="180" y="280" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Browser to Streamlit -->
        <mxCell id="arrow2" value="HTTP" style="endArrow=classic;startArrow=classic;html=1;strokeWidth=2;strokeColor=#1976d2;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="browser" target="streamlit-app">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="255" y="302" as="sourcePoint" />
            <mxPoint x="420" y="170" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Streamlit to Agent -->
        <mxCell id="arrow3" value="run()" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#f57c00;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="streamlit-app" target="dify-agent">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="620" y="170" as="sourcePoint" />
            <mxPoint x="770" y="175" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Agent to Chat Client -->
        <mxCell id="arrow4" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#ef6c00;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.25;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="dify-agent" target="dify-chat-client">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="815" y="205" as="sourcePoint" />
            <mxPoint x="800" y="220" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Agent to Knowledge Client -->
        <mxCell id="arrow5" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#ef6c00;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.75;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="dify-agent" target="dify-knowledge-client">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="905" y="205" as="sourcePoint" />
            <mxPoint x="932" y="220" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Chat Client to Dify Chat API -->
        <mxCell id="arrow6" value="REST" style="endArrow=classic;startArrow=classic;html=1;strokeWidth=2;strokeColor=#ec407a;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="dify-chat-client" target="chat-api">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="865" y="247" as="sourcePoint" />
            <mxPoint x="1070" y="175" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Knowledge Client to Knowledge API -->
        <mxCell id="arrow7" value="REST" style="endArrow=classic;startArrow=classic;html=1;strokeWidth=2;strokeColor=#ec407a;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="dify-knowledge-client" target="knowledge-api">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="990" y="247" as="sourcePoint" />
            <mxPoint x="1070" y="247" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Summarizer to Completion API -->
        <mxCell id="arrow8" value="REST" style="endArrow=classic;startArrow=classic;html=1;strokeWidth=2;strokeColor=#ec407a;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="dify-summarizer" target="completion-api">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="950" y="332" as="sourcePoint" />
            <mxPoint x="1070" y="317" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Chat API to LLM -->
        <mxCell id="arrow9" value="" style="endArrow=classic;startArrow=classic;html=1;strokeWidth=2;strokeColor=#880e4f;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="chat-api" target="llm-icon">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1200" y="175" as="sourcePoint" />
            <mxPoint x="1230" y="235" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- LLM to Knowledge Base -->
        <mxCell id="arrow10" value="RAG" style="endArrow=classic;startArrow=classic;html=1;strokeWidth=2;strokeColor=#880e4f;entryX=0.5;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="llm-icon" target="hie-knowledge">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1270" y="275" as="sourcePoint" />
            <mxPoint x="1270" y="290" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Session State to User History -->
        <mxCell id="arrow11" value="persist" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#3f51b5;dashed=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" source="session-state" target="user-history-store">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="520" y="375" as="sourcePoint" />
            <mxPoint x="175" y="465" as="targetPoint" />
            <Array as="points">
              <mxPoint x="520" y="420" />
              <mxPoint x="175" y="420" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Knowledge Client to Summarizer -->
        <mxCell id="arrow12" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#ef6c00;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.25;entryDx=0;entryDy=0;" edge="1" parent="1" source="dify-knowledge-client" target="dify-summarizer">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="932" y="275" as="sourcePoint" />
            <mxPoint x="950" y="311" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fafafa;strokeColor=#bdbdbd;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="1200" y="465" width="120" height="100" as="geometry" />
        </mxCell>

        <mxCell id="legend-title" value="&lt;b&gt;Legend&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="1200" y="468" width="120" height="15" as="geometry" />
        </mxCell>

        <mxCell id="legend1" value="" style="endArrow=classic;startArrow=classic;html=1;strokeWidth=2;strokeColor=#1976d2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1210" y="500" as="sourcePoint" />
            <mxPoint x="1250" y="500" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend1-text" value="Bidirectional" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="1255" y="493" width="60" height="15" as="geometry" />
        </mxCell>

        <mxCell id="legend2" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#ef6c00;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1210" y="520" as="sourcePoint" />
            <mxPoint x="1250" y="520" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend2-text" value="Internal Call" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="1255" y="513" width="60" height="15" as="geometry" />
        </mxCell>

        <mxCell id="legend3" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#3f51b5;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1210" y="540" as="sourcePoint" />
            <mxPoint x="1250" y="540" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend3-text" value="Persistence" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="1255" y="533" width="60" height="15" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>

  <diagram id="llm-flow-diagram" name="LLM Agentic Flow">
    <mxGraphModel dx="1400" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200" math="0" shadow="1">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="flow-title" value="HIE Support Agent - LLM Agentic Flow" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=28;fontStyle=1;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="800" height="50" as="geometry" />
        </mxCell>

        <mxCell id="flow-subtitle" value="Message Processing Pipeline with RAG and Memory Persistence" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=2;fontColor=#64748b;" vertex="1" parent="1">
          <mxGeometry x="400" y="65" width="800" height="30" as="geometry" />
        </mxCell>

        <!-- Start Node -->
        <mxCell id="start" value="&lt;b&gt;START&lt;/b&gt;&lt;br&gt;User sends message" style="ellipse;whiteSpace=wrap;html=1;fillColor=#4caf50;strokeColor=#2e7d32;strokeWidth=3;fontSize=11;fontColor=#ffffff;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="120" width="140" height="70" as="geometry" />
        </mxCell>

        <!-- Privacy Check -->
        <mxCell id="privacy-check" value="&lt;b&gt;Privacy Command?&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Check for data info/delete request&lt;/font&gt;" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff9c4;strokeColor=#fbc02d;strokeWidth=2;fontSize=10;fontColor=#f57f17;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="110" width="160" height="90" as="geometry" />
        </mxCell>

        <!-- Privacy Handler -->
        <mxCell id="privacy-handler" value="&lt;b&gt;Handle Privacy Request&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;_handle_data_info_request()&lt;br&gt;_handle_delete_data_request()&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff59d;strokeColor=#fbc02d;strokeWidth=2;fontSize=10;fontColor=#f57f17;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="240" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- Append User Message -->
        <mxCell id="append-user-msg" value="&lt;b&gt;Append User Message&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;_append_message(&quot;user&quot;, prompt)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1976d2;strokeWidth=2;fontSize=10;fontColor=#0d47a1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="500" y="120" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- Store User Message -->
        <mxCell id="store-user-msg" value="&lt;b&gt;Store User Message&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;DifyKnowledgeClient.store_message()&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c8e6c9;strokeColor=#43a047;strokeWidth=2;fontSize=10;fontColor=#1b5e20;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="500" y="210" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- Summarize User Message -->
        <mxCell id="summarize-user" value="&lt;b&gt;Summarize Message&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;DifySummarizer.summarize()&lt;br&gt;Extract: summary, name, HIE flag&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe0b2;strokeColor=#f57c00;strokeWidth=2;fontSize=10;fontColor=#e65100;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="500" y="300" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- Dify Agent Run -->
        <mxCell id="agent-run" value="&lt;b&gt;DifyAgent.run(prompt)&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Send to Dify Chat API&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcc80;strokeColor=#ef6c00;strokeWidth=2;fontSize=11;fontColor=#e65100;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="720" y="120" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- RAG Retrieval -->
        <mxCell id="rag-retrieval" value="&lt;b&gt;RAG Retrieval&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Search HIE Knowledge Base&lt;br&gt;Find relevant documents&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd9;strokeColor=#ec407a;strokeWidth=2;fontSize=10;fontColor=#880e4f;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="940" y="120" width="150" height="70" as="geometry" />
        </mxCell>

        <!-- LLM Processing -->
        <mxCell id="llm-processing" value="&lt;b&gt;LLM Processing&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Generate response with context&lt;br&gt;HIE expertise + user history&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e91e63;strokeColor=#880e4f;strokeWidth=2;fontSize=10;fontColor=#ffffff;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1140" y="120" width="150" height="70" as="geometry" />
        </mxCell>

        <!-- Extract Citations -->
        <mxCell id="extract-citations" value="&lt;b&gt;Extract Citations&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Parse retriever_resources&lt;br&gt;Normalize citation format&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f48fb1;strokeColor=#c2185b;strokeWidth=2;fontSize=10;fontColor=#880e4f;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1140" y="220" width="150" height="70" as="geometry" />
        </mxCell>

        <!-- Agent Response -->
        <mxCell id="agent-response" value="&lt;b&gt;AgentResponse&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;answer, conversation_id,&lt;br&gt;citations, metadata&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffb74d;strokeColor=#f57c00;strokeWidth=2;fontSize=10;fontColor=#e65100;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="940" y="220" width="150" height="70" as="geometry" />
        </mxCell>

        <!-- Render Response -->
        <mxCell id="render-response" value="&lt;b&gt;Render Response&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Display in chat_message&lt;br&gt;Show citations or &quot;Web&quot;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#90caf9;strokeColor=#1565c0;strokeWidth=2;fontSize=10;fontColor=#0d47a1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="720" y="220" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- Store Assistant Message -->
        <mxCell id="store-assistant" value="&lt;b&gt;Store Assistant Message&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;_append_message(&quot;assistant&quot;, answer)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c8e6c9;strokeColor=#43a047;strokeWidth=2;fontSize=10;fontColor=#1b5e20;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="720" y="320" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- Summarize Assistant -->
        <mxCell id="summarize-assistant" value="&lt;b&gt;Summarize Response&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;DifySummarizer.summarize()&lt;br&gt;Store in Knowledge Base&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe0b2;strokeColor=#f57c00;strokeWidth=2;fontSize=10;fontColor=#e65100;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="720" y="410" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- Rerun -->
        <mxCell id="rerun" value="&lt;b&gt;st.rerun()&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;Refresh UI&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#64b5f6;strokeColor=#1976d2;strokeWidth=2;fontSize=10;fontColor=#0d47a1;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="500" y="420" width="100" height="50" as="geometry" />
        </mxCell>

        <!-- End Node -->
        <mxCell id="end" value="&lt;b&gt;END&lt;/b&gt;&lt;br&gt;Await next input" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f44336;strokeColor=#c62828;strokeWidth=3;fontSize=11;fontColor=#ffffff;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="405" width="120" height="70" as="geometry" />
        </mxCell>

        <!-- Flow Arrows -->
        <mxCell id="flow1" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#2e7d32;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="start" target="privacy-check">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="220" y="155" as="sourcePoint" />
            <mxPoint x="280" y="155" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow2" value="YES" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#fbc02d;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="privacy-check" target="privacy-handler">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="360" y="200" as="sourcePoint" />
            <mxPoint x="360" y="240" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow3" value="NO" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#1976d2;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="privacy-check" target="append-user-msg">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="440" y="155" as="sourcePoint" />
            <mxPoint x="500" y="150" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow4" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#43a047;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="append-user-msg" target="store-user-msg">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="580" y="180" as="sourcePoint" />
            <mxPoint x="580" y="210" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow5" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#f57c00;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="store-user-msg" target="summarize-user">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="580" y="270" as="sourcePoint" />
            <mxPoint x="580" y="300" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow6" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#ef6c00;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="append-user-msg" target="agent-run">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="660" y="150" as="sourcePoint" />
            <mxPoint x="720" y="150" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow7" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#ec407a;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="agent-run" target="rag-retrieval">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="880" y="150" as="sourcePoint" />
            <mxPoint x="940" y="155" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow8" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#880e4f;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="rag-retrieval" target="llm-processing">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1090" y="155" as="sourcePoint" />
            <mxPoint x="1140" y="155" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow9" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#c2185b;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="llm-processing" target="extract-citations">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1215" y="190" as="sourcePoint" />
            <mxPoint x="1215" y="220" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow10" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#f57c00;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="extract-citations" target="agent-response">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1140" y="255" as="sourcePoint" />
            <mxPoint x="1090" y="255" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow11" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#1565c0;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="agent-response" target="render-response">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="940" y="255" as="sourcePoint" />
            <mxPoint x="880" y="255" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow12" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#43a047;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="render-response" target="store-assistant">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="800" y="290" as="sourcePoint" />
            <mxPoint x="800" y="320" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow13" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#f57c00;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="store-assistant" target="summarize-assistant">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="800" y="380" as="sourcePoint" />
            <mxPoint x="800" y="410" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow14" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#1976d2;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="summarize-assistant" target="rerun">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="720" y="445" as="sourcePoint" />
            <mxPoint x="600" y="445" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow15" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#c62828;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="rerun" target="end">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="500" y="445" as="sourcePoint" />
            <mxPoint x="400" y="440" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="flow16" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#c62828;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="privacy-handler" target="end">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="360" y="310" as="sourcePoint" />
            <mxPoint x="340" y="405" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Parallel Processing Indicator -->
        <mxCell id="parallel-note" value="&lt;font style=&quot;font-size:10px&quot;&gt;Parallel: Storage happens&lt;br&gt;alongside agent call&lt;/font&gt;" style="text;html=1;strokeColor=#43a047;fillColor=#e8f5e9;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=10;fontColor=#1b5e20;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="600" y="135" width="110" height="40" as="geometry" />
        </mxCell>

        <!-- Memory Context Box -->
        <mxCell id="memory-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#7986cb;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="490" y="200" width="180" height="180" as="geometry" />
        </mxCell>

        <mxCell id="memory-label" value="&lt;b&gt;MEMORY PERSISTENCE&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontStyle=1;fontColor=#3f51b5;" vertex="1" parent="1">
          <mxGeometry x="490" y="203" width="180" height="15" as="geometry" />
        </mxCell>

        <!-- Dify Platform Box -->
        <mxCell id="dify-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#ec407a;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="930" y="110" width="370" height="190" as="geometry" />
        </mxCell>

        <mxCell id="dify-label" value="&lt;b&gt;DIFY PLATFORM&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontStyle=1;fontColor=#c2185b;" vertex="1" parent="1">
          <mxGeometry x="930" y="93" width="100" height="15" as="geometry" />
        </mxCell>

        <!-- Conversation Context Indicator -->
        <mxCell id="conv-context" value="&lt;b&gt;Conversation Context&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;font-size:9px&quot;&gt;conversation_id maintains&lt;br&gt;multi-turn context&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#5c6bc0;strokeWidth=1;fontSize=10;fontColor=#303f9f;" vertex="1" parent="1">
          <mxGeometry x="940" y="315" width="150" height="60" as="geometry" />
        </mxCell>

        <mxCell id="conv-arrow" value="" style="endArrow=classic;startArrow=classic;html=1;strokeWidth=1;strokeColor=#5c6bc0;dashed=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="agent-response" target="conv-context">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1015" y="290" as="sourcePoint" />
            <mxPoint x="1015" y="315" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- HIE Knowledge Icon -->
        <mxCell id="hie-kb-icon" value="&lt;b&gt;HIE&lt;br&gt;Knowledge&lt;br&gt;Base&lt;/b&gt;" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=10;fillColor=#f48fb1;strokeColor=#c2185b;strokeWidth=2;fontSize=9;fontColor=#880e4f;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1110" y="315" width="70" height="70" as="geometry" />
        </mxCell>

        <mxCell id="kb-arrow" value="RAG" style="endArrow=classic;startArrow=classic;html=1;strokeWidth=1;strokeColor=#c2185b;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" source="rag-retrieval" target="hie-kb-icon">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1015" y="190" as="sourcePoint" />
            <mxPoint x="1145" y="315" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1015" y="280" />
              <mxPoint x="1145" y="280" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- User History Storage -->
        <mxCell id="user-history-icon" value="&lt;b&gt;User&lt;br&gt;History&lt;/b&gt;" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=10;fillColor=#a5d6a7;strokeColor=#388e3c;strokeWidth=2;fontSize=9;fontColor=#1b5e20;shadow=1;" vertex="1" parent="1">
          <mxGeometry x="1200" y="315" width="70" height="70" as="geometry" />
        </mxCell>

        <mxCell id="history-arrow" value="" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#388e3c;dashed=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" source="summarize-assistant" target="user-history-icon">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="880" y="445" as="sourcePoint" />
            <mxPoint x="1200" y="350" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1180" y="445" />
              <mxPoint x="1180" y="350" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Legend -->
        <mxCell id="flow-legend-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fafafa;strokeColor=#bdbdbd;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="500" width="300" height="80" as="geometry" />
        </mxCell>

        <mxCell id="flow-legend-title" value="&lt;b&gt;Flow Legend&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="90" y="505" width="100" height="15" as="geometry" />
        </mxCell>

        <mxCell id="legend-start" value="" style="ellipse;whiteSpace=wrap;html=1;fillColor=#4caf50;strokeColor=#2e7d32;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="90" y="525" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-start-text" value="Start" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="115" y="525" width="40" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-end" value="" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f44336;strokeColor=#c62828;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="160" y="525" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-end-text" value="End" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="185" y="525" width="40" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-decision" value="" style="rhombus;whiteSpace=wrap;html=1;fillColor=#fff9c4;strokeColor=#fbc02d;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="230" y="522" width="25" height="25" as="geometry" />
        </mxCell>
        <mxCell id="legend-decision-text" value="Decision" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="260" y="525" width="50" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-process" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#bbdefb;strokeColor=#1976d2;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="90" y="550" width="30" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-process-text" value="Process" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="125" y="550" width="50" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-storage" value="" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=5;fillColor=#a5d6a7;strokeColor=#388e3c;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="180" y="550" width="25" height="25" as="geometry" />
        </mxCell>
        <mxCell id="legend-storage-text" value="Storage" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="210" y="552" width="50" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-external" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd9;strokeColor=#ec407a;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="265" y="550" width="30" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-external-text" value="External API" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="300" y="550" width="70" height="20" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
